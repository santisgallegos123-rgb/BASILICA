<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FILSA | Gestión de Inventario</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-auth-compat.js"></script>

    <style>
        :root {
            --red: #b11226;
            --red-hover: #8f0e1f;
            --white: #ffffff;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --text-dark: #2d3436;
            --text-light: #636e72;
            --success: #00b894;
            --border: #edf2f7;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: var(--white);
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* --- LOGIN (Minimalist Gradient) --- */
        #loginWrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(rgba(177, 18, 38, 0.9), rgba(177, 18, 38, 0.9)), 
                        url('https://www.transparenttextures.com/patterns/cubes.png');
        }

        .login-card {
            background: white;
            padding: 50px 40px;
            border-radius: 20px;
            width: 100%;
            max-width: 420px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .login-card img { width: 220px; margin-bottom: 30px; }
        .login-field { margin-bottom: 20px; text-align: left; }
        .login-field label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.8rem; color: var(--text-light); text-transform: uppercase; }
        .login-field input { width: 100%; padding: 14px; border: 1px solid var(--gray-300); border-radius: 10px; font-family: inherit; transition: 0.3s; }
        .login-field input:focus { border-color: var(--red); }
        .login-btn { width: 100%; padding: 16px; background: var(--red); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.3s; letter-spacing: 1px; }
        .login-btn:hover { background: var(--red-hover); }

        /* --- NAVEGACIÓN --- */
        .hamburger-icon {
            position: fixed;
            top: 25px; right: 25px; z-index: 5000;
            background: var(--red); color: white; border: none;
            width: 50px; height: 50px; border-radius: 12px;
            cursor: pointer; font-size: 20px; transition: 0.3s;
        }

        #sideMenu {
            position: fixed;
            top: 0; right: -350px;
            width: 320px; height: 100%;
            background: var(--white); border-left: 1px solid var(--border);
            z-index: 4500; transition: 0.4s cubic-bezier(0.075, 0.82, 0.165, 1);
            padding: 100px 30px 30px;
        }

        #sideMenu.active { right: 0; }
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: none; z-index: 4400; backdrop-filter: blur(4px); }
        .menu-btn-side { width: 100%; padding: 15px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 12px; background: white; text-align: left; cursor: pointer; font-weight: 600; font-family: inherit; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .menu-btn-side:hover { background: var(--gray-100); color: var(--red); border-color: var(--red); }

        /* --- LAYOUT --- */
        #mainApp { display: none; padding: 40px 20px; }
        .container { max-width: 1500px; margin: auto; }
        .logo-header { text-align: left; margin-bottom: 40px; padding-left: 10px; }
        .logo-header img { width: 240px; }

        .main-layout { display: grid; grid-template-columns: 400px 1fr; gap: 40px; }

        .panel, .section {
            background: white;
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 30px;
        }

        h3 { color: var(--text-dark); margin-top: 0; font-size: 1.25rem; font-weight: 700; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; }
        h3 i { color: var(--red); font-size: 1.1rem; }

        label { display: block; margin-top: 18px; font-size: 0.75rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; }
        select, input { width: 100%; padding: 12px 15px; margin-top: 8px; border: 1px solid var(--gray-200); border-radius: 12px; background: var(--gray-100); font-family: inherit; font-size: 0.9rem; transition: 0.3s; }
        select:focus, input:focus { background: white; border-color: var(--red); }

        /* --- TABLA MAESTRA --- */
        .search-container { position: relative; margin-bottom: 20px; }
        .search-container i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-light); }
        .search-container input { padding-left: 45px; background: white; border: 1px solid var(--border); width: 100%; max-width: 400px; }

        .table-wrapper { max-height: 750px; overflow-y: auto; border-radius: 15px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { position: sticky; top: 0; background: white; text-align: left; padding: 18px; border-bottom: 2px solid var(--red); font-size: 0.8rem; text-transform: uppercase; color: var(--red); letter-spacing: 1px; z-index: 10; }
        td { padding: 16px 18px; border-bottom: 1px solid var(--border); font-size: 0.9rem; transition: 0.2s; }
        tr:hover td { background: var(--gray-100); }

        .badge { padding: 6px 14px; border-radius: 8px; font-weight: 700; font-size: 0.8rem; }
        .critical { background: #fff0f0; color: var(--red); border: 1px solid #ffcccc; }
        .normal { background: #e6fffb; color: var(--success); border: 1px solid #b3f5e9; }

        .btn-full { width: 100%; padding: 15px; border: none; border-radius: 12px; color: white; font-weight: 700; cursor: pointer; margin-top: 20px; transition: 0.3s; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .btn-full:active { transform: scale(0.98); }

        /* MODAL */
        #modalHistorial {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 95%; max-width: 1000px; background: white; border: 1px solid var(--border);
            border-radius: 30px; padding: 40px; z-index: 6000;
        }

        @media(max-width: 1100px) { .main-layout { grid-template-columns: 1fr; } .panel { position: static; } }
    </style>
</head>
<body>

<button class="hamburger-icon" id="btnHamburger" onclick="toggleMenu()" style="display:none;"><i class="fas fa-bars"></i></button>

<div class="menu-overlay" id="overlay" onclick="toggleMenu()"></div>
<div id="sideMenu">
    <h3><i class="fas fa-cog"></i> Opciones</h3>
    <button class="menu-btn-side" onclick="mostrarHistorial()"><i class="fas fa-history"></i> Historial de Movimientos</button>
    <button class="menu-btn-side" onclick="descargarPDF()"><i class="fas fa-file-pdf"></i> Exportar Reporte PDF</button>
    <hr style="border: 0; border-top: 1px solid var(--border); margin: 25px 0;">
    <button class="menu-btn-side" style="color:var(--red); border-color: #ffcccc;" onclick="cerrarSesion()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
</div>

<div id="loginWrapper">
    <div class="login-card">
        <img src="https://www.cofisatam.com.mx/img/portfolio/filsa.jpg" alt="FILSA">
        <div class="login-field"><label>Correo Corporativo</label><input type="email" id="user" placeholder="usuario@filsa.com"></div>
        <div class="login-field"><label>Contraseña</label><input type="password" id="pass" placeholder="••••••••"></div>
        <button class="login-btn" onclick="validarLogin()">INICIAR SISTEMA</button>
    </div>
</div>

<div id="mainApp">
    <div class="container">
        <div class="logo-header"><img src="https://www.cofisatam.com.mx/img/portfolio/filsa.jpg" alt="FILSA"></div>
        
        <div class="main-layout">
            <aside>
                <div class="panel" style="margin-bottom: 30px;">
                    <h3><i class="fas fa-arrow-down"></i> Entrada</h3>
                    <label>Seleccionar Material</label>
                    <select class="itemSelect"></select>
                    <label>Cantidad</label>
                    <input type="number" id="qtyEntrada" value="1" min="1">
                    <label>Número de Requisición</label>
                    <input type="text" id="reqEntrada" placeholder="REQ-000">
                    <button class="btn-full" style="background:var(--success);" onclick="registrar('entrada')">
                        <i class="fas fa-plus-circle"></i> INGRESAR STOCK
                    </button>
                </div>

                <div class="panel">
                    <h3><i class="fas fa-arrow-up"></i> Salida</h3>
                    <label>Seleccionar Material</label>
                    <select class="itemSelect"></select>
                    <label>Cantidad</label>
                    <input type="number" id="qtySalida" value="1" min="1">
                    <label>Folio de Salida</label>
                    <input type="text" id="folioSalida" placeholder="FOL-000">
                    <label>Modelo / Destino</label>
                    <input type="text" id="modeloSalida" placeholder="Nombre del Modelo">
                    <button class="btn-full" style="background:var(--red);" onclick="registrar('salida')">
                        <i class="fas fa-minus-circle"></i> REGISTRAR SALIDA
                    </button>
                </div>
            </aside>

            <main>
                <div class="section">
                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px; margin-bottom: 25px;">
                        <h3 style="margin:0;"><i class="fas fa-boxes-stacked"></i> Inventario Maestro</h3>
                        <div class="search-container">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchInput" onkeyup="filtrarTabla()" placeholder="Buscar material...">
                        </div>
                    </div>
                    
                    <div class="table-wrapper">
                        <table id="tablaMaestra">
                            <thead>
                                <tr><th>Descripción</th><th>Stock</th><th>Mín/Máx</th><th>Estado</th></tr>
                            </thead>
                            <tbody id="bodyListaMaestra"></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>
</div>

<div id="modalHistorial">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 30px;">
        <h3 style="margin:0;"><i class="fas fa-history"></i> Historial Reciente</h3>
        <button onclick="cerrarHistorial()" style="background:var(--gray-100); border:none; width:40px; height:40px; border-radius:50%; cursor:pointer;"><i class="fas fa-times"></i></button>
    </div>
    <div style="max-height: 500px; overflow-y: auto; border-radius: 15px; border: 1px solid var(--border);">
        <table>
            <thead style="background: var(--gray-100);"><tr><th>Fecha</th><th>Item</th><th>Cant</th><th>Mov</th><th>Referencia</th></tr></thead>
            <tbody id="listaHistorial"></tbody>
        </table>
    </div>
</div>

<script>
    // Configuración Firebase (La misma proporcionada)
    const firebaseConfig = {
        apiKey: "AIzaSyArJXmpHrZNbGz3AYRtz2pg_g-PghfxgkI",
        authDomain: "basilica-c0fe0.firebaseapp.com",
        databaseURL: "https://basilica-c0fe0-default-rtdb.firebaseio.com",
        projectId: "basilica-c0fe0",
        storageBucket: "basilica-c0fe0.firebasestorage.app",
        messagingSenderId: "287745460477",
        appId: "1:287745460477:web:be24ed1deb6398c5c11694"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    let inventory = [];

    // --- SEGURIDAD: CIERRE AL REFRESCAR ---
    auth.setPersistence(firebase.auth.Auth.Persistence.NONE);

    auth.onAuthStateChanged(user => {
        if(user){
            document.getElementById("loginWrapper").style.display="none";
            document.getElementById("mainApp").style.display="block";
            document.getElementById("btnHamburger").style.display="block";
            init();
        } else {
            document.getElementById("loginWrapper").style.display="flex";
            document.getElementById("mainApp").style.display="none";
            document.getElementById("btnHamburger").style.display="none";
        }
    });

    function validarLogin(){
        const u = document.getElementById("user").value;
        const p = document.getElementById("pass").value;
        auth.signInWithEmailAndPassword(u, p).catch(e => alert("Acceso denegado: Verifique sus credenciales."));
    }

    function cerrarSesion(){ auth.signOut(); location.reload(); }
    
    function toggleMenu() {
        const m = document.getElementById("sideMenu");
        const o = document.getElementById("overlay");
        m.classList.toggle("active");
        o.style.display = m.classList.contains("active") ? "block" : "none";
    }

    function init() {
        db.ref('inventario').on('value', snap => {
            inventory = snap.val() || [];
            render();
        });
    }

    function render() {
        const bodyMaestro = document.getElementById("bodyListaMaestra");
        const selects = document.querySelectorAll(".itemSelect");
        bodyMaestro.innerHTML = "";
        selects.forEach(s => s.innerHTML = "");

        inventory.forEach((item, index) => {
            if(!item) return;
            const isCrit = item.min > 0 && item.stock < item.min;
            bodyMaestro.innerHTML += `<tr>
                <td><strong>${item.id}</strong></td>
                <td><span class="badge ${isCrit ? 'critical' : 'normal'}">${item.stock}</span></td>
                <td><span style="color:var(--text-light); font-size:0.8rem;">${item.min} / ${item.max}</span></td>
                <td>${isCrit ? '<b style="color:var(--red);">REQUISICIÓN</b>' : '<b style="color:var(--success);">ÓPTIMO</b>'}</td>
            </tr>`;

            selects.forEach(s => {
                const opt = document.createElement("option");
                opt.value = index; opt.textContent = item.id;
                s.appendChild(opt);
            });
        });
    }

    function filtrarTabla() {
        let input = document.getElementById("searchInput").value.toLowerCase();
        let rows = document.getElementById("bodyListaMaestra").getElementsByTagName("tr");
        for (let row of rows) {
            row.style.display = row.innerText.toLowerCase().includes(input) ? "" : "none";
        }
    }

    function registrar(tipo) {
        const isEntrada = tipo === 'entrada';
        const select = document.querySelectorAll(".itemSelect")[isEntrada ? 0 : 1];
        const idx = select.value;
        const qty = parseInt(document.getElementById(isEntrada ? "qtyEntrada" : "qtySalida").value);
        const ref = isEntrada ? 
            document.getElementById("reqEntrada").value : 
            `${document.getElementById("folioSalida").value} | ${document.getElementById("modeloSalida").value}`;

        if(isNaN(qty) || qty <= 0) return alert("Ingrese una cantidad válida");
        let nStock = isEntrada ? inventory[idx].stock + qty : inventory[idx].stock - qty;
        if(nStock < 0) return alert("No hay suficiente existencia en inventario.");

        if(confirm(`¿Desea registrar esta ${tipo} de material?`)) {
            db.ref(`inventario/${idx}`).update({ stock: nStock });
            db.ref('historial').push({
                item: inventory[idx].id, mov: (isEntrada ? '+' : '-') + qty,
                tipo: tipo.toUpperCase(), ref: ref || "S/R", fecha: new Date().toLocaleString()
            });
            // Reset campos
            if(isEntrada) document.getElementById("reqEntrada").value = "";
            else { document.getElementById("folioSalida").value = ""; document.getElementById("modeloSalida").value = ""; }
        }
    }

    function mostrarHistorial() {
        toggleMenu();
        document.getElementById("modalHistorial").style.display = "block";
        document.getElementById("overlay").style.display = "block";
        db.ref('historial').limitToLast(50).once('value', snap => {
            const lista = document.getElementById("listaHistorial");
            lista.innerHTML = "";
            let data = [];
            snap.forEach(c => { data.unshift(c.val()); });
            data.forEach(h => {
                lista.innerHTML += `<tr>
                    <td><small>${h.fecha}</small></td>
                    <td><b>${h.item}</b></td>
                    <td style="color:${h.mov.includes('+') ? 'var(--success)' : 'var(--red)'}"><b>${h.mov}</b></td>
                    <td><small>${h.tipo}</small></td>
                    <td><small>${h.ref}</small></td>
                </tr>`;
            });
        });
    }

    function cerrarHistorial() {
        document.getElementById("modalHistorial").style.display = "none";
        document.getElementById("overlay").style.display = "none";
    }

    function descargarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFont("helvetica", "bold");
        doc.text("FILSA - REPORTE DE INVENTARIO MAESTRO", 14, 20);
        doc.setFontSize(10);
        doc.text(`Generado el: ${new Date().toLocaleString()}`, 14, 28);
        const filas = inventory.map(i => [i.id, i.stock, `${i.min}/${i.max}`, i.stock < i.min ? "REQUISICIÓN" : "OK"]);
        doc.autoTable({ 
            startY: 35, 
            head: [['Descripción', 'Stock Actual', 'Mín/Máx', 'Estado']], 
            body: filas,
            headStyles: { fillColor: [177, 18, 38] },
            theme: 'grid'
        });
        doc.save(`Reporte_Filsa_${new Date().toLocaleDateString()}.pdf`);
    }
</script>
</body>
</html>

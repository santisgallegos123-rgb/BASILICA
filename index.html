<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FILSA | Gestión de Inventario Pro</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-auth-compat.js"></script>

    <style>
        :root {
            --red: #b11226;
            --red-hover: #8f0e1f;
            --white: #ffffff;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --text-dark: #2d3436;
            --text-light: #636e72;
            --success: #00b894;
            --border: #edf2f7;
            --blue: #0984e3;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: var(--white);
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* --- LOGIN --- */
        #loginWrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(rgba(177, 18, 38, 0.9), rgba(177, 18, 38, 0.9)), 
                        url('https://www.transparenttextures.com/patterns/cubes.png');
        }

        .login-card {
            background: white;
            padding: 50px 40px;
            border-radius: 20px;
            width: 100%;
            max-width: 420px;
            text-align: center;
        }

        .login-card img { width: 220px; margin-bottom: 30px; }
        .login-field { margin-bottom: 20px; text-align: left; }
        .login-field label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.8rem; color: var(--text-light); text-transform: uppercase; }
        .login-field input { width: 100%; padding: 14px; border: 1px solid var(--gray-300); border-radius: 10px; }
        .login-btn { width: 100%; padding: 16px; background: var(--red); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.3s; }

        /* --- NAV --- */
        .hamburger-icon {
            position: fixed;
            top: 25px; right: 25px; z-index: 5000;
            background: var(--red); color: white; border: none;
            width: 50px; height: 50px; border-radius: 12px; cursor: pointer;
        }

        #sideMenu {
            position: fixed;
            top: 0; right: -350px;
            width: 320px; height: 100%;
            background: var(--white); border-left: 1px solid var(--border);
            z-index: 4500; transition: 0.4s; padding: 100px 30px 30px;
        }

        #sideMenu.active { right: 0; }
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.2); display: none; z-index: 4400; }
        .menu-btn-side { width: 100%; padding: 15px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 12px; background: white; text-align: left; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 10px; }

        /* --- LAYOUT --- */
        #mainApp { display: none; padding: 40px 20px; }
        .container { max-width: 1600px; margin: auto; }
        .main-layout { display: grid; grid-template-columns: 350px 1fr; gap: 30px; }

        .panel, .section {
            background: white;
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }

        h3 { color: var(--text-dark); margin-top: 0; font-size: 1.1rem; border-bottom: 1px solid var(--gray-100); padding-bottom: 15px; margin-bottom: 20px; }
        
        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .full-col { grid-column: span 2; }

        input, select { width: 100%; padding: 10px; border: 1px solid var(--gray-200); border-radius: 8px; margin-top: 5px; font-family: inherit; }

        /* --- TABLA --- */
        .table-wrapper { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; border-bottom: 2px solid var(--red); color: var(--red); font-size: 0.8rem; }
        td { padding: 12px 15px; border-bottom: 1px solid var(--border); font-size: 0.85rem; }

        .badge { padding: 4px 10px; border-radius: 6px; font-weight: 600; font-size: 0.75rem; }
        .critical { background: #fff0f0; color: var(--red); }
        .normal { background: #e6fffb; color: var(--success); }

        .btn-action { border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .btn-edit { background: var(--gray-100); color: var(--blue); }
        .btn-delete { background: var(--gray-100); color: var(--red); margin-left: 5px; }

        .btn-full { width: 100%; padding: 12px; border: none; border-radius: 10px; color: white; font-weight: 600; cursor: pointer; margin-top: 15px; }

        #modalAdmin {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 500px; background: white; padding: 30px; border-radius: 20px; z-index: 6000; box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<button class="hamburger-icon" id="btnHamburger" onclick="toggleMenu()" style="display:none;"><i class="fas fa-bars"></i></button>
<div class="menu-overlay" id="overlay" onclick="toggleMenu()"></div>

<div id="sideMenu">
    <h3><i class="fas fa-cog"></i> Opciones</h3>
    <button class="menu-btn-side" onclick="abrirAdmin()"><i class="fas fa-plus-circle"></i> Nuevo Material</button>
    <button class="menu-btn-side" onclick="mostrarHistorial()"><i class="fas fa-history"></i> Historial</button>
    <button class="menu-btn-side" onclick="descargarPDF()"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
    <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">
    <button class="menu-btn-side" style="color:var(--red);" onclick="cerrarSesion()"><i class="fas fa-sign-out-alt"></i> Salir</button>
</div>

<div id="loginWrapper">
    <div class="login-card">
        <img src="https://www.cofisatam.com.mx/img/portfolio/filsa.jpg" alt="FILSA">
        <div class="login-field"><label>Correo</label><input type="email" id="user" placeholder="usuario@filsa.com"></div>
        <div class="login-field"><label>Contraseña</label><input type="password" id="pass" placeholder="••••••••"></div>
        <button class="login-btn" onclick="validarLogin()">ENTRAR</button>
    </div>
</div>

<div id="mainApp">
    <div class="container">
        <div class="main-layout">
            <aside>
                <div class="panel" style="margin-bottom: 20px;">
                    <h3><i class="fas fa-arrow-down"></i> Entrada</h3>
                    <label style="font-size: 0.7rem; font-weight: bold;">MATERIAL</label>
                    <select class="itemSelect"></select>
                    <div class="grid-form">
                        <div><label style="font-size: 0.7rem;">CANT.</label><input type="number" id="qtyEntrada" value="1"></div>
                        <div><label style="font-size: 0.7rem;">REQ.</label><input type="text" id="reqEntrada" placeholder="000"></div>
                    </div>
                    <button class="btn-full" style="background:var(--success);" onclick="registrar('entrada')">INGRESAR</button>
                </div>

                <div class="panel">
                    <h3><i class="fas fa-arrow-up"></i> Salida</h3>
                    <label style="font-size: 0.7rem; font-weight: bold;">MATERIAL</label>
                    <select class="itemSelect"></select>
                    <div class="grid-form">
                        <div><label style="font-size: 0.7rem;">CANT.</label><input type="number" id="qtySalida" value="1"></div>
                        <div><label style="font-size: 0.7rem;">FOLIO</label><input type="text" id="folioSalida" placeholder="000"></div>
                        <div class="full-col"><label style="font-size: 0.7rem;">DESTINO/MODELO</label><input type="text" id="modeloSalida"></div>
                    </div>
                    <button class="btn-full" style="background:var(--red);" onclick="registrar('salida')">DESPACHAR</button>
                </div>
            </aside>

            <main>
                <div class="section">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3 style="margin:0; border:0; padding:0;">Inventario Maestro</h3>
                        <input type="text" id="searchInput" onkeyup="filtrarTabla()" placeholder="Buscar..." style="width:250px; margin:0;">
                    </div>
                    <div class="table-wrapper">
                        <table id="tablaMaestra">
                            <thead>
                                <tr>
                                    <th>Descripción</th>
                                    <th>Stock</th>
                                    <th>Uni.</th>
                                    <th>Mín/Máx</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="bodyListaMaestra"></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>
</div>

<div id="modalAdmin">
    <h3 id="adminTitle">Nuevo Material</h3>
    <input type="hidden" id="editIdx">
    <div class="grid-form">
        <div class="full-col"><label>Descripción del Material</label><input type="text" id="admDesc"></div>
        <div><label>Stock Inicial</label><input type="number" id="admStock" value="0"></div>
        <div><label>Unidad (Pza, Kg...)</label><input type="text" id="admUni" placeholder="Pzas"></div>
        <div><label>Mínimo</label><input type="number" id="admMin" value="0"></div>
        <div><label>Máximo</label><input type="number" id="admMax" value="0"></div>
    </div>
    <div style="display:flex; gap:10px; margin-top:20px;">
        <button class="btn-full" style="background:var(--success);" onclick="guardarMaterial()">GUARDAR</button>
        <button class="btn-full" style="background:var(--gray-300); color:var(--text-dark);" onclick="cerrarAdmin()">CANCELAR</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyArJXmpHrZNbGz3AYRtz2pg_g-PghfxgkI",
        authDomain: "basilica-c0fe0.firebaseapp.com",
        databaseURL: "https://basilica-c0fe0-default-rtdb.firebaseio.com",
        projectId: "basilica-c0fe0",
        storageBucket: "basilica-c0fe0.firebasestorage.app",
        messagingSenderId: "287745460477",
        appId: "1:287745460477:web:be24ed1deb6398c5c11694"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    let inventory = [];

    auth.setPersistence(firebase.auth.Auth.Persistence.NONE);

    auth.onAuthStateChanged(user => {
        if(user){
            document.getElementById("loginWrapper").style.display="none";
            document.getElementById("mainApp").style.display="block";
            document.getElementById("btnHamburger").style.display="block";
            init();
        } else {
            document.getElementById("loginWrapper").style.display="flex";
            document.getElementById("mainApp").style.display="none";
        }
    });

    function validarLogin(){
        const u = document.getElementById("user").value;
        const p = document.getElementById("pass").value;
        auth.signInWithEmailAndPassword(u, p).catch(e => alert("Error de acceso"));
    }

    function cerrarSesion(){ auth.signOut(); location.reload(); }
    function toggleMenu() {
        const m = document.getElementById("sideMenu");
        const o = document.getElementById("overlay");
        m.classList.toggle("active");
        o.style.display = m.classList.contains("active") ? "block" : "none";
    }

    function init() {
        db.ref('inventario').on('value', snap => {
            inventory = snap.val() || [];
            render();
        });
    }

    function render() {
        const bodyMaestro = document.getElementById("bodyListaMaestra");
        const selects = document.querySelectorAll(".itemSelect");
        bodyMaestro.innerHTML = "";
        selects.forEach(s => s.innerHTML = "");

        inventory.forEach((item, index) => {
            if(!item) return;
            const isCrit = item.stock < item.min;
            bodyMaestro.innerHTML += `<tr>
                <td><strong>${item.id}</strong></td>
                <td><span class="badge ${isCrit ? 'critical' : 'normal'}">${item.stock}</span></td>
                <td>${item.unit || '---'}</td>
                <td><small>${item.min} / ${item.max}</small></td>
                <td>${isCrit ? '<b style="color:var(--red);">BAJO</b>' : '<b style="color:var(--success);">OK</b>'}</td>
                <td>
                    <button class="btn-action btn-edit" onclick="editarMaterial(${index})"><i class="fas fa-edit"></i></button>
                    <button class="btn-action btn-delete" onclick="eliminarMaterial(${index})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;

            selects.forEach(s => {
                const opt = document.createElement("option");
                opt.value = index; opt.textContent = item.id;
                s.appendChild(opt);
            });
        });
    }

    // --- FUNCIONES DE DESARROLLADOR ---
    function abrirAdmin() {
        document.getElementById("adminTitle").innerText = "Nuevo Material";
        document.getElementById("editIdx").value = "";
        document.getElementById("admDesc").value = "";
        document.getElementById("admStock").value = 0;
        document.getElementById("admUni").value = "Pzas";
        document.getElementById("admMin").value = 0;
        document.getElementById("admMax").value = 0;
        document.getElementById("modalAdmin").style.display = "block";
        document.getElementById("overlay").style.display = "block";
    }

    function cerrarAdmin() {
        document.getElementById("modalAdmin").style.display = "none";
        document.getElementById("overlay").style.display = "none";
    }

    function editarMaterial(idx) {
        const item = inventory[idx];
        document.getElementById("adminTitle").innerText = "Editar Material";
        document.getElementById("editIdx").value = idx;
        document.getElementById("admDesc").value = item.id;
        document.getElementById("admStock").value = item.stock;
        document.getElementById("admUni").value = item.unit || "";
        document.getElementById("admMin").value = item.min;
        document.getElementById("admMax").value = item.max;
        document.getElementById("modalAdmin").style.display = "block";
        document.getElementById("overlay").style.display = "block";
    }

    function guardarMaterial() {
        const idx = document.getElementById("editIdx").value;
        const nuevoData = {
            id: document.getElementById("admDesc").value.toUpperCase(),
            stock: parseInt(document.getElementById("admStock").value),
            unit: document.getElementById("admUni").value,
            min: parseInt(document.getElementById("admMin").value),
            max: parseInt(document.getElementById("admMax").value)
        };

        if(!nuevoData.id) return alert("La descripción es obligatoria");

        if(idx === "") {
            // Es uno nuevo
            inventory.push(nuevoData);
        } else {
            // Actualizar existente
            inventory[idx] = nuevoData;
        }

        db.ref('inventario').set(inventory).then(() => {
            cerrarAdmin();
            alert("Inventario actualizado correctamente");
        });
    }

    function eliminarMaterial(idx) {
        if(confirm("¿Seguro que desea eliminar este material del catálogo?")) {
            inventory.splice(idx, 1);
            db.ref('inventario').set(inventory);
        }
    }

    // --- MOVIMIENTOS ---
    function registrar(tipo) {
        const isEntrada = tipo === 'entrada';
        const select = document.querySelectorAll(".itemSelect")[isEntrada ? 0 : 1];
        const idx = select.value;
        const qty = parseInt(document.getElementById(isEntrada ? "qtyEntrada" : "qtySalida").value);
        
        if(isNaN(qty) || qty <= 0) return alert("Cantidad inválida");
        let nStock = isEntrada ? inventory[idx].stock + qty : inventory[idx].stock - qty;
        if(nStock < 0) return alert("Stock insuficiente");

        db.ref(`inventario/${idx}`).update({ stock: nStock });
        db.ref('historial').push({
            item: inventory[idx].id, mov: (isEntrada ? '+' : '-') + qty,
            tipo: tipo.toUpperCase(), fecha: new Date().toLocaleString()
        });
        alert("Registro exitoso");
    }

    function filtrarTabla() {
        let input = document.getElementById("searchInput").value.toLowerCase();
        let rows = document.getElementById("bodyListaMaestra").getElementsByTagName("tr");
        for (let row of rows) {
            row.style.display = row.innerText.toLowerCase().includes(input) ? "" : "none";
        }
    }

    function descargarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("REPORTE DE INVENTARIO FILSA", 14, 20);
        const filas = inventory.map(i => [i.id, i.stock, i.unit, `${i.min}/${i.max}`]);
        doc.autoTable({ 
            startY: 30, 
            head: [['Material', 'Stock', 'Unidad', 'Mín/Máx']], 
            body: filas,
            headStyles: { fillColor: [177, 18, 38] }
        });
        doc.save("Inventario.pdf");
    }
</script>
</body>
</html>

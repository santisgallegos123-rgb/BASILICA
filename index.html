<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAS√çLICA | Control de Almac√©n</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.1/firebase-auth-compat.js"></script> 

    <style>
        :root{
            --red:#b71c1c;
            --red-light:#e53935;
            --white:#ffffff;
            --bg:#f2f2f2;
            --success:#2e7d32;
            --danger:#c62828;                                               
            --shadow:0 8px 20px rgba(0, 0, 0, 0.1);
        }

        *{box-sizing:border-box}
        body{ margin:0; font-family:"Segoe UI", sans-serif; background:var(--bg); overflow-x: hidden; }

        #loginWrapper {
            display: flex; justify-content: center; align-items: center;
            height: 100vh; background: linear-gradient(135deg,var(--red),var(--red-light));
        }
        .login-card {
            background: white; padding: 40px; border-radius: 18px;
            width: 360px; text-align: center; box-shadow: var(--shadow);
        }
        .login-card img{ max-width:200px; margin-bottom:15px; border-radius: 8px; }

        #mainApp { display: none; }
        
        .top-bar {
            background: var(--red); color: white; padding: 10px 25px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .top-bar img{ height:35px; border-radius: 4px; }

        /* MEN√ö LATERAL */
        .side-menu {
            height: 100%; width: 0; position: fixed; z-index: 2000;
            top: 0; right: 0; background-color: white; 
            overflow-x: hidden; transition: 0.4s;
            padding-top: 60px; box-shadow: -10px 0 30px rgba(0,0,0,0.2);
        }

        .close-btn {
            position: absolute; top: 15px; left: 20px;
            font-size: 14px; font-weight: bold; color: #888;
            cursor: pointer; border: 1px solid #ddd; padding: 5px 10px; border-radius: 5px;
        }

        .overlay {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            z-index: 1500;
        }

        .side-menu button {
            padding: 16px 25px; font-size: 15px; color: #444;
            display: flex; align-items: center; gap: 15px; width: 90%;
            margin: 8px auto; text-align: left; border: none; background: none;
            cursor: pointer; border-radius: 12px; transition: 0.3s;
        }
        .side-menu button:hover { background-color: #fcebeb; color: var(--red); }

        .menu-icon {
            cursor: pointer; display: flex; flex-direction: column;
            justify-content: space-around; width: 30px; height: 25px;
            background: transparent; border: none;
        }
        .menu-icon div { width: 30px; height: 3px; background-color: white; border-radius: 5px; }

        /* MODALES */
        .modal {
            display: none; position: fixed; z-index: 3000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.6);
        }
        .modal-content {
            background-color: white; margin: 5% auto; padding: 25px;
            border-radius: 15px; width: 95%; max-width: 900px; max-height: 85vh; overflow-y: auto;
        }

        .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }
        .main-layout { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        .card-box { background: white; padding: 20px; border-radius: 16px; box-shadow: var(--shadow); }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #fafafa; padding: 12px; text-align: left; border-bottom: 2px solid #eee; font-size: 0.75rem; color: #666; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 0.85rem; }
        
        input, select, .btn-submit { width: 100%; padding: 12px; margin: 5px 0 15px 0; border-radius: 8px; border: 1px solid #ddd; }
        .btn-submit { border: none; color: white; font-weight: bold; cursor: pointer; }
        .btn-in { background: var(--success); }
        .btn-out { background: var(--danger); }
        
        .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 0.65rem; font-weight: bold; }
        .critical { background: #ffd7d7; color: #b71c1c; }
        .ok { background: #d7ffd9; color: #2e7d32; }

        .edit-btn { background: none; border: none; cursor: pointer; color: #999; }
        .edit-btn:hover { color: var(--red); transform: scale(1.1); }

        @media(max-width: 1000px) { .main-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body onload="forzarLogin()">

<div id="overlay" class="overlay" onclick="closeMenu()"></div>

<div id="sideMenu" class="side-menu">
    <span class="close-btn" onclick="closeMenu()">‚úï CERRAR</span>
    
    <div style="text-align:center; padding:20px; margin-top:20px;">
        <img src="https://www.cofisatam.com.mx/img/portfolio/filsa.jpg" style="width:80px; border-radius:10px;">
        <h3 style="color:var(--red); margin:10px 0;">FILSA</h3>
    </div>
    <button onclick="openHistorial()"><span>üìú</span> Historial de Movimientos</button>
    <button onclick="exportarPDF()"><span>üìÑ</span> Descargar Reporte PDF</button>
    <button onclick="cerrarSesion()" style="color:var(--danger); margin-top:30px;"><span>üö™</span> Cerrar Sesi√≥n</button>
</div>

<div id="modalHistorial" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0; color:var(--red);">Historial de Movimientos</h2>
            <button onclick="closeModal('modalHistorial')" style="border:none; background:var(--red); color:white; padding:5px 15px; border-radius:5px; cursor:pointer;">Cerrar</button>
        </div>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr><th>Fecha</th><th>Tipo</th><th>Material</th><th>Cant.</th><th>Unidad</th><th>Ref/Modelo</th></tr>
                </thead>
                <tbody id="historialBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="modalEditar" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <h2 id="editMaterialName" style="color:var(--red); font-size:1.1rem; margin-top:0;">Ajustar Material</h2>
        <input type="hidden" id="editKey">
        
        <label><b>Stock Actual:</b></label>
        <input type="number" id="editStock" step="0.1" style="border: 1px solid var(--red);">

        <label><b>Unidad de Medida (m, kg, pzs...):</b></label>
        <input type="text" id="editUnitManual" placeholder="Ej: kg">
        
        <label>M√≠nimo:</label>
        <input type="number" id="editMin" step="0.1">
        
        <label>M√°ximo:</label>
        <input type="number" id="editMax" step="0.1">
        
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn-submit" style="background:#666;" onclick="closeModal('modalEditar')">Cancelar</button>
            <button class="btn-submit" style="background:var(--success);" onclick="guardarEdicion()">Guardar</button>
        </div>
    </div>
</div>

<div id="loginWrapper">
    <div class="login-card">
        <img src="https://www.cofisatam.com.mx/img/portfolio/filsa.jpg">
        <h3 style="color:var(--red);">SISTEMA DE CONTROL</h3>
        <input type="email" id="user" placeholder="Usuario">
        <input type="password" id="pass" placeholder="Contrase√±a">
        <button class="btn-submit" style="background:var(--red);" onclick="validarLogin()">INGRESAR</button>
    </div>
</div>

<div id="mainApp">
    <header class="top-bar">
        <div style="display:flex; align-items:center; gap:10px;">
            <img src="https://www.cofisatam.com.mx/img/portfolio/filsa.jpg">
            <span style="font-weight:bold;">ALMAC√âN GENERAL</span>
        </div>
        <button class="menu-icon" onclick="openMenu()"><div></div><div></div><div></div></button>
    </header>

    <div class="container">
        <div class="main-layout">
            <div class="column-actions">
                <div class="card-box" style="border-top:5px solid var(--danger); margin-bottom:20px;">
                    <h2 style="font-size:1rem; color:var(--danger);">REGISTRAR SALIDA</h2>
                    <select id="out_item"></select>
                    <input type="number" id="out_qty" placeholder="Cantidad" step="0.1">
                    <input type="text" id="out_unit" placeholder="Confirmar Unidad" readonly style="background:#f9f9f9; color:#888;">
                    <input type="text" id="out_model" placeholder="Modelo / Uso">
                    <input type="text" id="out_ref" placeholder="Referencia">
                    <button class="btn-submit btn-out" onclick="procesar('salida')">DAR DE BAJA</button>
                </div>
                <div class="card-box" style="border-top:5px solid var(--success);">
                    <h2 style="font-size:1rem; color:var(--success);">REGISTRAR ENTRADA</h2>
                    <select id="in_item"></select>
                    <input type="number" id="in_qty" placeholder="Cantidad" step="0.1">
                    <input type="text" id="in_unit" placeholder="Confirmar Unidad" readonly style="background:#f9f9f9; color:#888;">
                    <input type="text" id="in_model" placeholder="Modelo">
                    <input type="text" id="in_ref" placeholder="Referencia">
                    <button class="btn-submit btn-in" onclick="procesar('entrada')">DAR DE ALTA</button>
                </div>
            </div>

            <div class="card-box">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 style="margin:0; font-size:1rem;">EXISTENCIAS</h2>
                    <input type="text" id="busqueda" placeholder="üîé Buscar..." style="width:200px; margin:0;">
                </div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Descripci√≥n</th>
                                <th style="text-align:center;">Unidad</th>
                                <th style="text-align:center;">M√≠n</th>
                                <th style="text-align:center;">M√°x</th>
                                <th style="text-align:center;">Stock</th>
                                <th style="text-align:center;">Estado</th>
                                <th style="text-align:center;">Edit</th>
                            </tr>
                        </thead>
                        <tbody id="tablaBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyA_CeDhAhWEyqBO5rO0yo2JdttXKz5CCjU",
        authDomain: "basilica-dd3b1.firebaseapp.com",
        databaseURL: "https://basilica-dd3b1-default-rtdb.firebaseio.com",
        projectId: "basilica-dd3b1",
        storageBucket: "basilica-dd3b1.firebasestorage.app",
        messagingSenderId: "1000902846657",
        appId: "1:1000902846657:web:5739da8a32cbb425b74c40"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    function forzarLogin() { auth.signOut(); }

    let materiales = [];

    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById("loginWrapper").style.display = "none";
            document.getElementById("mainApp").style.display = "block";
            cargarDatos();
        } else {
            document.getElementById("loginWrapper").style.display = "flex";
            document.getElementById("mainApp").style.display = "none";
        }
    });

    function cargarDatos() {
        db.ref('inventario_basilica').on('value', snap => {
            const data = snap.val();
            if(data){
                materiales = Object.keys(data).map(k => ({ key: k, ...data[k] }));
                renderizar();
            }
        });
    }

    function renderizar() {
        const body = document.getElementById("tablaBody");
        const selIn = document.getElementById("in_item");
        const selOut = document.getElementById("out_item");
        const query = document.getElementById("busqueda").value.toLowerCase();
        
        body.innerHTML = "";
        selIn.innerHTML = selOut.innerHTML = "<option value=''>-- Seleccionar --</option>";

        materiales.sort((a,b) => a.n.localeCompare(b.n)).forEach(m => {
            if (query && !m.n.toLowerCase().includes(query)) return;
            const bajo = m.s < (m.min || 0);
            const unidad = m.u || '-';
            
            body.innerHTML += `<tr>
                <td>${m.n}</td>
                <td style="text-align:center; color:#666;">${unidad}</td>
                <td style="text-align:center; color:#888;">${m.min || 0}</td>
                <td style="text-align:center; color:#888;">${m.max || 0}</td>
                <td style="text-align:center;"><strong>${m.s}</strong></td>
                <td style="text-align:center;"><span class="status-pill ${bajo ? 'critical' : 'ok'}">${bajo ? 'BAJO' : 'OK'}</span></td>
                <td style="text-align:center;"><button class="edit-btn" onclick="abrirEditor('${m.key}', '${m.n}', ${m.min || 0}, ${m.max || 0}, ${m.s}, '${unidad}')">‚öôÔ∏è</button></td>
            </tr>`;
            let opt = `<option value="${m.key}">${m.n}</option>`;
            selIn.innerHTML += opt; selOut.innerHTML += opt;
        });
    }

    // Al seleccionar un item para entrada/salida, autocompletar la unidad
    document.getElementById("in_item").addEventListener("change", (e) => {
        const item = materiales.find(m => m.key === e.target.value);
        document.getElementById("in_unit").value = item ? (item.u || '') : '';
    });
    document.getElementById("out_item").addEventListener("change", (e) => {
        const item = materiales.find(m => m.key === e.target.value);
        document.getElementById("out_unit").value = item ? (item.u || '') : '';
    });

    function abrirEditor(key, nombre, min, max, stock, unidad) {
        document.getElementById("editKey").value = key;
        document.getElementById("editMaterialName").innerText = nombre;
        document.getElementById("editMin").value = min;
        document.getElementById("editMax").value = max;
        document.getElementById("editStock").value = stock;
        document.getElementById("editUnitManual").value = unidad === '-' ? '' : unidad;
        document.getElementById("modalEditar").style.display = "block";
    }

    function guardarEdicion() {
        const key = document.getElementById("editKey").value;
        const nuevoMin = parseFloat(document.getElementById("editMin").value) || 0;
        const nuevoMax = parseFloat(document.getElementById("editMax").value) || 0;
        const nuevoStock = parseFloat(document.getElementById("editStock").value) || 0;
        const nuevaUnidad = document.getElementById("editUnitManual").value.trim();

        db.ref(`inventario_basilica/${key}`).update({ 
            min: nuevoMin, 
            max: nuevoMax,
            s: nuevoStock,
            u: nuevaUnidad
        })
        .then(() => { closeModal('modalEditar'); alert("Material actualizado"); });
    }

    function validarLogin() {
        const u = document.getElementById("user").value.trim();
        const p = document.getElementById("pass").value.trim();
        auth.signInWithEmailAndPassword(u, p).catch(() => alert("Error de acceso"));
    }

    function procesar(tipo) {
        const pfx = tipo === 'entrada' ? 'in' : 'out';
        const id = document.getElementById(`${pfx}_item`).value;
        const qty = parseFloat(document.getElementById(`${pfx}_qty`).value);
        const ref = document.getElementById(`${pfx}_ref`).value;
        const mod = document.getElementById(`${pfx}_model`).value;

        if (!id || isNaN(qty) || qty <= 0) { alert("Complete los campos"); return; }

        const item = materiales.find(x => x.key === id);
        let total = tipo === 'entrada' ? item.s + qty : item.s - qty;
        if (total < 0) { alert("Stock insuficiente"); return; }

        db.ref(`inventario_basilica/${id}`).update({ s: total });
        db.ref('historial_basilica').push({
            fecha: new Date().toLocaleString(),
            tipo: tipo.toUpperCase(),
            material: item.n,
            cantidad: qty,
            unidad: item.u || 'N/A',
            referencia: ref || '-',
            modelo: mod || '-'
        });
        alert("Operaci√≥n completada");
        document.getElementById(`${pfx}_qty`).value = "";
    }

    function openMenu() { document.getElementById("sideMenu").style.width = "280px"; document.getElementById("overlay").style.display = "block"; }
    function closeMenu() { document.getElementById("sideMenu").style.width = "0"; document.getElementById("overlay").style.display = "none"; }
    function closeModal(id) { document.getElementById(id).style.display = "none"; }
    function cerrarSesion() { auth.signOut(); }
    document.getElementById("busqueda").addEventListener("input", renderizar);

    function openHistorial() { 
        closeMenu(); 
        document.getElementById("modalHistorial").style.display = "block"; 
        db.ref('historial_basilica').limitToLast(50).on('value', snap => {
            const body = document.getElementById("historialBody");
            body.innerHTML = "";
            const data = snap.val();
            if(data) Object.values(data).reverse().forEach(h => {
                body.innerHTML += `<tr><td>${h.fecha}</td><td>${h.tipo}</td><td>${h.material}</td><td>${h.cantidad}</td><td>${h.unidad}</td><td>${h.referencia}</td></tr>`;
            });
        });
    }

    function exportarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("REPORTE FILSA", 14, 15);
        const filas = materiales.map(m => [m.n, m.u || '-', m.min || 0, m.max || 0, m.s]);
        doc.autoTable({ head: [['Material', 'Unidad', 'Min', 'Max', 'Stock']], body: filas, startY: 20 });
        doc.save("Inventario.pdf");
    }
</script>
</body>
</html>
